{% extends "shop/base.html" %}
{% load static %}
{% block content %}
<div class="row">
  <div class="col-md-3">
    <h5>Filters</h5>
    <div class="mb-2">
      <input id="search" class="form-control" placeholder="Search...">
    </div>
    <div class="mb-2">
      <input id="min_price" class="form-control" placeholder="Min price">
    </div>
    <div class="mb-2">
      <input id="max_price" class="form-control" placeholder="Max price">
    </div>
    <button id="applyFilters" class="btn btn-sm btn-outline-primary">Apply</button>
  </div>

  <div class="col-md-9">
    <div id="itemsRow" class="row g-3"></div>
  </div>
</div>

<script>
async function fetchItems() {
  const params = new URLSearchParams();
  const q = document.getElementById('search').value;
  if (q) params.append('q', q);
  const min = document.getElementById('min_price').value;
  if (min) params.append('min_price', min);
  const max = document.getElementById('max_price').value;
  if (max) params.append('max_price', max);

  const res = await fetch('/api/items/?' + params.toString());
  const items = await res.json();
  const row = document.getElementById('itemsRow');
  row.innerHTML = '';

  items.forEach(i => {
    const col = document.createElement('div'); 
    col.className = 'col-md-4';
    col.innerHTML = `
      <div class="card h-100 shadow-sm">
        <!-- Product Image -->
        ${i.image ? `<img src="${i.image}" class="card-img-top" style="height:220px;object-fit:cover;border-bottom:1px solid #eee;">` 
                  : `<img src="{% static 'img/no-image.png' %}" class="card-img-top" style="height:220px;object-fit:cover;border-bottom:1px solid #eee;">`}
        
        <div class="card-body d-flex flex-column">
          <!-- Title -->
          <h5 class="card-title">${i.title}</h5>
          
          <!-- Description -->
          <p class="card-text text-muted">${i.description?.slice(0,100) || ''}</p>
          
          <!-- Price + Add to Cart -->
          <div class="mt-auto d-flex justify-content-between align-items-center">
            <strong class="text-success fs-5">â‚¹ ${i.price}</strong>
            <button class="btn btn-sm btn-primary" onclick="addToCart(${i.id})">
              Add to cart
            </button>
          </div>
        </div>
      </div>
    `;
    row.appendChild(col);
  });
}

document.getElementById('applyFilters').onclick = fetchItems;
window.onload = fetchItems;

async function addToCart(itemId) {
  const token = localStorage.getItem('access');
  if (!token) {
    alert('Please login to add items to cart'); 
    window.location.href = '/login/'; 
    return;
  }
  const res = await fetch('/api/cart/', {
    method:'POST',
    headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token},
    body: JSON.stringify({ item_id: itemId, quantity: 1 })
  });
  if (res.ok) alert('Added to cart');
  else if (res.status === 401) {
    alert('Session expired. Please login again.'); 
    window.location.href = '/login/';
  } else alert('Error adding to cart');
}
</script>
{% endblock %}
